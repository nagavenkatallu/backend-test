jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Authenticate to Google Cloud
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Deploy to GCE via SSH
        run: |
          echo "--- 1. Setting up the SSH key ---"
          echo "${{ secrets.GCP_SSH_PRIVATE_KEY }}" > ssh_key
          chmod 600 ssh_key

          echo "--- 2. Fetching the VM's IP address ---"
          IP_ADDRESS=$(gcloud compute instances describe ${{ secrets.GCE_INSTANCE_NAME }} \
            --zone=${{ secrets.GCE_INSTANCE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          echo "VM IP address is $IP_ADDRESS"

          echo "--- 3. Copying the application JAR to the VM ---"
          scp -o StrictHostKeyChecking=no -i ./ssh_key \
            ./target/*.jar \
            ci_user@$IP_ADDRESS:/home/ci_user/app.jar

          echo "--- 4. Stopping, clearing logs, and starting the service ---"
          ssh -o StrictHostKeyChecking=no -i ./ssh_key \
            ci_user@$IP_ADDRESS \
            '
              echo "--> Stopping service..."
              sudo systemctl stop backend-test

              echo "--> Clearing logs..."
              sudo journalctl --rotate
              sudo journalctl --vacuum-time=1s -u backend-test

              echo "--> Starting service..."
              sudo systemctl start backend-test
          
              echo "--> Verifying service is active..."
              sudo systemctl is-active --quiet backend-test
            '
          
          echo "--- Deployment complete ---"